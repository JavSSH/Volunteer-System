{% extends "layout.html" %}
{% block title %}User Management Dashboard{% endblock %}
{% block content %}

<div class="dashboard-wrapper">
  <div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="m-0">User Management</h1>
      <div class="d-flex gap-2 align-items-center mb-3">
        <!-- Create Entities -->
        <div class="d-flex align-items-center gap-3" style="margin-bottom: 25px;">
          <a href="{{ url_for('createUserAccountPage') }}" class="plain-btn">Create New Account</a>
          <a href="{{ url_for('viewUserProfilePage', user_id=session.get('user_id')) }}" class="plain-btn">
            View User Profiles
          </a>
        </div>
      </div>
    </div>
    </div>

    <!-- Search & Filters -->
  <form class="card mb-4" method="get" action="{{ url_for('viewUserAccountPage') }}">
  <div class="card-header">
    <h5 class="m-0">Search</h5>
  </div>
  <div class="card-body row g-3">
    <div class="col-md-10">
      <label class="form-label">Search users</label>
      <input id="userKeywordInput" name="user_keyword" value="{{ request.args.get('user_keyword','') }}" type="text" class="form-control" placeholder="Enter a name, email, or ID">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="plain-btn" type="submit"><i class="bi bi-search"></i>Search</button>
    </div>
  </div>
</form>

    <!-- Users table -->
    {% if not users %}
    <h2 style="text-align: center;">No such user found!</h3>
    {% else %}
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">All Users ({{ users|length }})</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover m-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 80px;">ID</th>
                <th>Name</th>
                <th>Email</th>
                <th style="width: 160px;">Role</th>
                <th style="width: 120px;">Status</th>
                <th style="width: 160px;">Created</th>
                <th style="width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td class="text-monospace">{{ user.user_id }}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td><a href="mailto:{{ user.email }}">{{ user.email }}</a></td>
                <td>
                  {% if user.role_id == 1 %}
                    <span class="badge bg-user-admin">User Admin</span>
                  {% elif user.role_id == 2 %}
                    <span class="badge bg-platform-manager">Platform Manager</span>
                  {% elif user.role_id == 3 %}
                    <span class="badge bg-pin">Person In Need</span>
                  {% elif user.role_id == 4 %}
                    <span class="badge bg-csr-rep">CSR Rep</span>
                  {% endif %}
                </td>
                <td>
                  {% if user.is_active == 1 %}
                    <span class="badge bg-active">Active</span>
                  {% else %}
                    <span class="badge bg-suspended">Suspended</span>
                  {% endif %}
                </td>
                <td>{{ user.created_at }}</td>
                <td>
                  <div class="btn-toolbar" role="toolbar">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                      <!-- Update account -->
                      <a class="btn btn-sm" href="{{ url_for('other_dashboard', user_id=user.user_id) }}" title="Edit User" style="width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; background-color: white; border: 1px solid #dee2e6; border-radius: 5px !important;">
                        <i class="bi bi-pencil-square" style="color: #0d6efd; font-size: 16px;"></i>
                      </a>
                      
                      {% if user.is_active == 1 %}
                        <!-- Suspend -->
                        <form method="post" action="{{ url_for('suspendUserAccountPage', user_id=user.user_id) }}" style="display: inline-block; margin: 0;">
                          <button class="btn btn-sm" type="submit" title="Suspend User" style="width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: #dc3545; color: white; border: none; cursor: pointer; border-radius: 5px;">
                            <i class="bi bi-x-circle" style="color: white; font-size: 16px;"></i>
                          </button>
                        </form>
                      {% else %}
                        <!-- Reactivate -->
                        <form method="post" action="{{ url_for('reactivateUserAccountPage', user_id=user.user_id) }}" style="display: inline-block; margin: 0;">
                          <button class="btn btn-sm" type="submit" title="Reactivate User" style="width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: #198754; color: white; border: none; cursor: pointer; border-radius: 5px;">
                            <i class="bi bi-check2-circle" style="color: white; font-size: 16px;"></i>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination (optional) -->
      {% if pagination %}
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">Page {{ pagination.page }} of {{ pagination.pages }}</div>
        <nav>
          <ul class="pagination m-0">
            <li class="page-item {{ 'disabled' if not pagination.prev_num }}">
              <a class="page-link" href="{{ url_for('viewUserAccountPage', page=pagination.prev_num, user_keyword=request.args.get('user_keyword')) }}">Prev</a>
            </li>
            <li class="page-item {{ 'disabled' if not pagination.next_num }}">
              <a class="page-link" href="{{ url_for('viewUserAccountPage', page=pagination.next_num, user_keyword=request.args.get('user_keyword')) }}">Next</a>
            </li>
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Optional helper styles (can be moved to your CSS) -->
<style>
  .bg-user-admin{background:#4c6ef5}
  .bg-platform-manager{background:#2fb344}
  .bg-pin{background:#f59f00}
  .bg-csr-rep{background:#d6336c}
  .bg-active{background:#198754}
  .bg-suspended{background:#6c757d}
  .text-monospace{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>

<script>
  // Show all results when search field is empty
  document.getElementById('userKeywordInput').addEventListener('input', function(e) {
    const keyword = this.value.trim().toLowerCase();
    
    // Auto-submit the form when field is completely empty
    if (keyword === '') {
      // Submit the form after a short delay to ensure visual feedback
      setTimeout(() => {
        document.querySelector('form').submit();
      }, 200);
    }
  });
  // Client-side quick search filter for specific users
  (function(){
    const input = document.getElementById('quickSearch');
    if(!input) return;
    const table = document.querySelector('table.table');
    if(!table) return;
    const rows = table.querySelectorAll('tbody tr');
    input.addEventListener('input', function(){
      const user_keyword = this.value.trim().toLowerCase();
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(user_keyword) ? '' : 'none';
      });
    });
  })();
</script>

{% endblock %}
